<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Learning Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0284c7',
              600: '#0369a1',
              700: '#075985',
            },
            brand: {
              purple: '#a435f0',
              dark: '#2d2f31',
              light: '#1e1e1c',
            }
          },
        },
      },
    }
  </script>
  <style>
    .course-card {
      transition: all 0.2s ease-in-out;
      display: flex;
      flex-direction: column;
    }
    .course-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    .progress-bar-animated {
      background-size: 30px 30px;
      background-image: linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.15) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.15) 50%,
        rgba(255, 255, 255, 0.15) 75%,
        transparent 75%,
        transparent
      );
      animation: progress-bar-stripes 1s linear infinite;
    }
    @keyframes progress-bar-stripes {
      from { background-position: 30px 0; }
      to { background-position: 0 0; }
    }
    .lesson-button:hover .lesson-icon {
      transform: translateX(4px);
    }
    .lesson-icon {
      transition: transform 0.2s ease;
    }

    /* Custom scrollbar styles */
    .overflow-y-auto::-webkit-scrollbar {
      width: 6px;
      display: block; /* Ensure scrollbar is always visible */
    }

    .overflow-y-auto::-webkit-scrollbar-track {
      background: #f3f4f6;
      border-radius: 8px;
    }

    .overflow-y-auto::-webkit-scrollbar-thumb {
      background-color: #d1d5db;
      border-radius: 8px;
    }

    .overflow-y-auto::-webkit-scrollbar-thumb:hover {
      background-color: #a435f0;
    }

    /* Add this new class to force scrollbars to display */
    .scrollbar-visible {
      overflow-y: scroll !important; /* Force showing scrollbar */
      scrollbar-width: thin !important;
      scrollbar-color: #a435f0 #f3f4f6 !important;
    }

    /* Ensure webkit browsers also show scrollbars */
    .scrollbar-visible::-webkit-scrollbar {
      width: 6px !important;
      display: block !important; /* Ensure scrollbar is always visible */
    }

    .scrollbar-visible::-webkit-scrollbar-track {
      background: #f3f4f6 !important;
      border-radius: 8px !important;
    }

    .scrollbar-visible::-webkit-scrollbar-thumb {
      background-color: #d1d5db !important;
      border-radius: 8px !important;
    }

    .scrollbar-visible::-webkit-scrollbar-thumb:hover {
      background-color: #a435f0 !important;
    }

    /* Force scrollbar to always show */
    .always-show-scrollbar {
      overflow-y: scroll !important;
      height: 12rem !important;
      min-height: 12rem !important;
      border: 1px solid #e5e7eb !important;
      border-radius: 0.375rem !important;
      padding: 0.5rem !important;
    }

    /* For WebKit browsers (Chrome, Safari, Edge) */
    .always-show-scrollbar::-webkit-scrollbar {
      width: 6px !important;
      display: block !important;
    }

    .always-show-scrollbar::-webkit-scrollbar-track {
      background: #f3f4f6 !important;
      border-radius: 6px !important;
    }

    .always-show-scrollbar::-webkit-scrollbar-thumb {
      background: #a435f0 !important;
      border-radius: 6px !important;
    }

    /* For Firefox */
    .always-show-scrollbar {
      scrollbar-width: thin !important;
      scrollbar-color: #a435f0 #f3f4f6 !important;
    }

    /* Sidebar collapse/expand styles */
    #sidebar {
      transition: width 0.3s ease, min-width 0.3s ease;
      overflow-x: hidden;
    }
    
    #sidebar.collapsed {
      width: 0 !important;
      min-width: 0 !important;
      border-right: none;
    }
    
    /* Toggle button to reopen sidebar when collapsed */
    #expandButton {
      position: fixed;
      left: 0;
      top: 5rem;
      background: white;
      padding: 0.75rem 0.5rem;
      border-radius: 0 0.25rem 0.25rem 0;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      z-index: 40;
      display: none;
    }
    
    #expandButton.visible {
      display: block;
    }

    /* Course tree styles */
    .course-tree-item {
      border-radius: 0.375rem;
      transition: all 0.2s ease;
    }

    .course-tree-item.enrolled {
      border-left: 3px solid #a435f0;
    }

    .course-tree-toggle {
      transition: transform 0.2s ease;
    }

    .course-tree-toggle.rotated {
      transform: rotate(90deg);
    }

    .course-tree-lessons {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .course-tree-lessons.expanded {
      max-height: 500px;
    }

    .course-tree-lesson {
      padding-left: 1.75rem;
      margin-top: 0.25rem;
      font-size: 0.875rem;
      border-radius: 0.25rem;
    }

    .course-tree-progress {
      height: 4px;
      background-color: #e5e7eb;
      border-radius: 9999px;
      overflow: hidden;
    }

    .course-tree-progress-bar {
      height: 100%;
      border-radius: 9999px;
    }

    .course-filter-badge {
      font-size: 0.65rem;
      padding: 0.125rem 0.375rem;
      border-radius: 9999px;
    }

    .course-filter-badge.active {
      color: white;
      background-color: #a435f0;
    }

    .course-filter-badge:not(.active) {
      color: #6b7280;
      background-color: #f3f4f6;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <!-- Top Navigation -->
  <nav class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <span id="brandLogo" class="text-2xl font-bold text-brand-purple">
            <i class="fas fa-graduation-cap mr-2"></i>
            <span id="navTitle">Learning Platform</span>
          </span>
        </div>
        
        <div class="flex items-center">
          <button class="ml-4 p-2 rounded-full hover:bg-gray-100">
            <i class="fas fa-user-circle text-gray-500 text-xl"></i>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Add this after your navigation and before the main content div -->
  <button id="expandButton" class="text-gray-500 hover:text-brand-purple">
    <i class="fas fa-chevron-right"></i>
  </button>

  <!-- Main Content with Sidebar -->
  <div class="max-w-7xl mx-auto flex">
    <!-- Left Sidebar -->
    <div id="sidebar" class="w-64 bg-white border-r border-gray-200 h-[calc(100vh-4rem)] sticky top-16 overflow-y-auto">
      <!-- Add this toggle button at the top -->
      <div class="flex justify-end p-2">
        <button id="sidebarToggle" class="text-gray-500 hover:text-brand-purple p-1 rounded-md">
          <i class="fas fa-chevron-left"></i>
        </button>
      </div>
      
      <div class="p-4">
        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">
          Navigation
        </h3>

        <!-- Navigation Links -->
        <div class="space-y-2">
          <button id="showAllCoursesBtn" class="flex items-center w-full px-3 py-2 text-gray-900 rounded-md hover:bg-gray-100 group active-nav-item">
            <i class="fas fa-book-open mr-3 text-brand-purple"></i>
            <span class="font-medium">All Courses</span>
          </button>
          
          <button id="showMyProgressBtn" class="flex items-center w-full px-3 py-2 text-gray-600 rounded-md hover:bg-gray-100 group">
            <i class="fas fa-chart-line mr-3 text-gray-400"></i>
            <span class="font-medium">My Progress</span>
          </button>
        </div>
      </div>

      <!-- Course Tree List -->
      <div id="courseTree" class="mt-4 border-t border-gray-200 pt-4">
        <div class="flex items-center justify-between px-4 mb-3">
          <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">
            Courses
          </h3>
          <div class="flex items-center space-x-1">
            <button id="filterAllCourses" class="course-filter-badge active">All</button>
            <button id="filterEnrolledCourses" class="course-filter-badge">Enrolled</button>
          </div>
        </div>
        
        <div class="px-2 mb-2">
          <div class="relative">
            <input 
              id="courseTreeSearch" 
              type="text" 
              placeholder="Filter courses..." 
              class="w-full py-1 px-2 pl-7 text-sm border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-brand-purple focus:border-brand-purple"
            >
            <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none">
              <i class="fas fa-search text-gray-400 text-xs"></i>
            </div>
            <button id="clearTreeSearch" class="absolute inset-y-0 right-0 flex items-center pr-2 text-gray-400 hover:text-gray-600 hidden">
              <i class="fas fa-times text-xs"></i>
            </button>
          </div>
        </div>
        
        <div class="space-y-1 px-2 overflow-y-auto" style="max-height: calc(100vh - 13rem);">
          <ul id="courseTreeList" class="space-y-1">
            <!-- Course tree will be generated here -->
          </ul>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 p-6">
      <!-- Content Pages - Only one will be shown at a time -->
      
      <!-- All Courses Page -->
      <div id="allCoursesPage" class="block">
        <div class="mb-8 border-b border-gray-200 pb-4">
          <h1 id="platformTitle" class="text-3xl font-bold text-gray-900 mb-2">My Courses</h1>
          <div class="flex items-center justify-between flex-wrap gap-4">
            <p class="text-gray-600">Continue learning where you left off</p>
            
            <!-- Add search bar here -->
            <div class="relative w-full max-w-md">
              <input 
                id="searchInput" 
                type="text" 
                placeholder="Search for courses or lessons..." 
                class="w-full py-2 pl-10 pr-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-purple focus:border-transparent"
              >
              <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <i class="fas fa-search text-gray-400"></i>
              </div>
              <button id="clearSearch" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600 hidden">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>
        
        <div id="courses" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
      </div>
      
      <!-- My Progress Page -->
      <div id="myProgressPage" class="hidden">
        <div class="mb-8 border-b border-gray-200 pb-4">
          <h1 class="text-3xl font-bold text-gray-900">My Learning Progress</h1>
          <p class="mt-2 text-gray-600">Track your course completion and achievements</p>
        </div>
        
        <div id="progressStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
          <!-- Progress statistics cards -->
          <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-500">Courses in Progress</p>
                <h3 id="coursesInProgressCount" class="text-3xl font-bold text-gray-900">0</h3>
              </div>
              <div class="bg-blue-100 p-3 rounded-full">
                <i class="fas fa-book text-blue-500 text-xl"></i>
              </div>
            </div>
          </div>
          
          <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-500">Lessons Completed</p>
                <h3 id="lessonsCompletedCount" class="text-3xl font-bold text-gray-900">0</h3>
              </div>
              <div class="bg-green-100 p-3 rounded-full">
                <i class="fas fa-check-circle text-green-500 text-xl"></i>
              </div>
            </div>
          </div>
          
          <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium text-gray-500">Overall Progress</p>
                <h3 id="overallProgressPercent" class="text-3xl font-bold text-gray-900">0%</h3>
              </div>
              <div class="bg-purple-100 p-3 rounded-full">
                <i class="fas fa-chart-pie text-brand-purple text-xl"></i>
              </div>
            </div>
          </div>
        </div>
        
        <div id="courseProgressList" class="space-y-6">
          <!-- Course progress details will be rendered here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Video Modal -->
  <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg w-full max-w-4xl shadow-2xl overflow-hidden">
      <div class="bg-gray-100 border-b border-gray-200 px-6 py-4 flex justify-between items-center">
        <h2 id="lessonTitle" class="text-xl font-bold text-gray-800 truncate"></h2>
        <button onclick="closeVideo()" class="text-gray-500 hover:text-red-600 focus:outline-none">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div id="videoContainer" class="p-6">
        <!-- Regular video player (for MP4) -->
        <video id="lessonVideo" class="w-full rounded-lg shadow-lg hidden" controls></video>
        
        <!-- YouTube iframe (for YouTube videos) -->
        <div id="youtubeContainer" class="relative pt-0 w-full hidden">
          <div id="youtubePlayer" class="w-full rounded-lg shadow-lg aspect-video"></div>
        </div>
      </div>
      
      <div class="bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-between">
        <button id="restartButton" onclick="restartLesson()" 
                class="flex items-center bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-md font-medium opacity-50 cursor-not-allowed" disabled>
          <i class="fas fa-redo mr-2"></i>
          Restart Lesson
        </button>
        <button id="markCompletedButton" onclick="markCompleted()" 
                class="flex items-center bg-brand-purple hover:bg-purple-700 text-white px-6 py-3 rounded-md font-medium">
          <i class="fas fa-check-circle mr-2"></i>
          Mark as Completed
        </button>
      </div>
    </div>
  </div>

  <!-- Add this after the video modal section -->

  <!-- Document Modal -->
  <div id="documentModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg w-full max-w-4xl shadow-2xl overflow-hidden">
      <div class="bg-gray-100 border-b border-gray-200 px-6 py-4 flex justify-between items-center">
        <h2 id="documentTitle" class="text-xl font-bold text-gray-800 truncate"></h2>
        <button onclick="closeDocument()" class="text-gray-500 hover:text-red-600 focus:outline-none">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div class="p-6 overflow-y-auto" style="max-height: 70vh;">
        <!-- Document viewer container -->
        <div id="documentContainer" class="w-full">
          <!-- PowerPoint Viewer -->
          <div id="powerpointViewer" class="hidden">
            <div class="bg-gray-50 border rounded-lg p-4">
              <div id="slideNavigator" class="flex items-center justify-between mb-4">
                <button id="prevSlide" class="px-3 py-1 bg-gray-200 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <span id="slideCounter" class="text-sm font-medium">Slide 1 of 24</span>
                <button id="nextSlide" class="px-3 py-1 bg-gray-200 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              <div id="slideFrame" class="w-full aspect-video bg-white rounded border border-gray-200 flex items-center justify-center">
                <iframe 
                  src="" 
                  width="100%" 
                  height="100%" 
                  frameborder="0"
                  class="w-full aspect-video">
                </iframe>
              </div>
            </div>
            <div class="mt-4">
              <p class="text-sm text-gray-600 mb-2"><i class="fas fa-info-circle mr-1"></i> For full interactive features:</p>
              <a id="externalPptLink" href="#" target="_blank" class="text-sm text-brand-purple hover:underline flex items-center">
                <i class="fas fa-external-link-alt mr-1"></i> Open in Microsoft PowerPoint Online
              </a>
            </div>
          </div>
          
          <!-- Word Document Viewer -->
          <div id="wordViewer" class="hidden">
            <div class="bg-gray-50 border rounded-lg p-4">
              <div id="pageNavigator" class="flex items-center justify-between mb-4">
                <button id="prevPage" class="px-3 py-1 bg-gray-200 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <span id="pageCounter" class="text-sm font-medium">Page 1 of 12</span>
                <button id="nextPage" class="px-3 py-1 bg-gray-200 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              <div id="documentFrame" class="w-full bg-white rounded border border-gray-200 min-h-[500px] flex items-center justify-center">
                <div id="scrollContainer" class="w-full h-[500px] overflow-auto relative">
                  <iframe 
                    id="wordDocFrame"
                    src="" 
                    width="100%" 
                    height="100%" 
                    frameborder="0"
                    class="min-h-[500px] w-full">
                  </iframe>
                  <div id="scrollTracker" class="absolute right-2 top-2 bg-gray-800 bg-opacity-75 text-white px-2 py-1 rounded text-xs">
                    Page 1 of 12
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-4">
              <p class="text-sm text-gray-600 mb-2"><i class="fas fa-info-circle mr-1"></i> For full interactive features:</p>
              <a id="externalDocLink" href="#" target="_blank" class="text-sm text-brand-purple hover:underline flex items-center">
                <i class="fas fa-external-link-alt mr-1"></i> Open in Microsoft Word Online
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <div class="bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-between">
        <div class="flex items-center">
          <span id="documentProgress" class="text-sm text-gray-600">
            <span id="progressPercent">0%</span> complete
          </span>
          <div class="ml-3 bg-gray-200 h-2 w-24 rounded-full overflow-hidden">
            <div id="progressBar" class="bg-brand-purple h-full" style="width: 0%"></div>
          </div>
        </div>
        
        <button id="markDocumentCompletedButton" onclick="markDocumentCompleted()" 
                class="flex items-center bg-brand-purple hover:bg-purple-700 text-white px-6 py-3 rounded-md font-medium">
          <i class="fas fa-check-circle mr-2"></i>
          Mark as Completed
        </button>
      </div>
    </div>
  </div>

  <script>
    // Add document handling functions

    // Current document tracking variables
    let currentDocumentSlide = 1;
    let currentDocumentPage = 1;
    let totalSlides = 0;
    let totalPages = 0;

    // Function to open documents based on their type
    function openDocument(lesson) {
      // Find the course this lesson belongs to
      const course = courses.find(c => c.lessons.some(l => l.id === lesson.id));
      const courseId = course ? course.id : null;
      
      if (!courseId) {
        console.error("Could not find course for lesson:", lesson);
        return;
      }
      
      // Check enrollment
      if (!checkEnrollmentStatus(courseId)) {
        showToast('Please enroll in this course to view lessons', 'warning');
        return;
      }
      
      // Set current lesson and course IDs
      currentLessonId = lesson.id;
      currentCourseId = courseId;
      
      // Set document title
      document.getElementById('documentTitle').textContent = lesson.title;
      
      // Show document modal
      document.getElementById('documentModal').classList.remove('hidden');
      
      // Hide all viewers initially
      document.getElementById('powerpointViewer').classList.add('hidden');
      document.getElementById('wordViewer').classList.add('hidden');
      
      // Get progress data
      const progress = getStoredProgress(courseId, lesson.id);
      updateDocumentProgressIndicator(progress * 100);
      
      if (lesson.documentType === 'powerpoint') {
        handlePowerPoint(lesson, courseId, progress);
      } else if (lesson.documentType === 'word') {
        handleWordDocument(lesson, courseId, progress);
      }
      
      // Update the completion button state
      updateDocumentCompletionButton(courseId, lesson.id);
    }

    // Handle PowerPoint presentations
    function handlePowerPoint(lesson, courseId, progress) {
      // Show PowerPoint viewer
      document.getElementById('powerpointViewer').classList.remove('hidden');
      
      // Set total slides
      totalSlides = lesson.totalSlides || 1;
      
      // Calculate current slide from progress
      currentDocumentSlide = progress > 0 ? 
        Math.max(1, Math.min(Math.ceil(progress * totalSlides), totalSlides)) : 1;
      
      // Update slide counter
      document.getElementById('slideCounter').textContent = `Slide ${currentDocumentSlide} of ${totalSlides}`;
      
      // Use Microsoft's Office Online viewer with slide parameter
      const slideFrame = document.getElementById('slideFrame');
      slideFrame.innerHTML = `
        <iframe 
          src="https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(lesson.documentUrl)}&wdSlideId=${currentDocumentSlide}" 
          width="100%" 
          height="100%" 
          frameborder="0"
          class="w-full aspect-video">
        </iframe>
      `;
      
      // Set up external link
      document.getElementById('externalPptLink').href = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(lesson.documentUrl)}`;
      
      // Set up navigation buttons
      const prevBtn = document.getElementById('prevSlide');
      const nextBtn = document.getElementById('nextSlide');
      
      prevBtn.disabled = currentDocumentSlide <= 1;
      nextBtn.disabled = currentDocumentSlide >= totalSlides;
      
      prevBtn.onclick = () => navigateSlide(-1);
      nextBtn.onclick = () => navigateSlide(1);
    }

    // Handle Word documents
    function handleWordDocument(lesson, courseId, progress) {
      // Show Word viewer
      document.getElementById('wordViewer').classList.remove('hidden');
      
      // Set total pages
      totalPages = lesson.pageCount || 1;
      
      // Calculate current page from progress
      currentDocumentPage = progress > 0 ? 
        Math.max(1, Math.min(Math.ceil(progress * totalPages), totalPages)) : 1;
      
      // Update page counter
      document.getElementById('pageCounter').textContent = `Page ${currentDocumentPage} of ${totalPages}`;
      
      // Use Microsoft's Office Online viewer with a container that we can monitor
      const documentFrame = document.getElementById('documentFrame');
      documentFrame.innerHTML = `
        <div id="scrollContainer" class="w-full h-[500px] overflow-auto relative">
          <iframe 
            id="wordDocFrame"
            src="https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(lesson.documentUrl)}" 
            width="100%" 
            height="${totalPages * 100}%" 
            frameborder="0"
            style="min-height: 500px; height: ${totalPages * 100}%;"
            scrolling="no">
          </iframe>
          <div id="scrollTracker" class="absolute right-2 top-2 bg-gray-800 bg-opacity-75 text-white px-2 py-1 rounded text-xs">
            Page 1 of ${totalPages}
          </div>
        </div>
      `;
      
      // Set up external link
      document.getElementById('externalDocLink').href = `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(lesson.documentUrl)}`;
      
      // Set up navigation buttons
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      
      prevBtn.disabled = currentDocumentPage <= 1;
      nextBtn.disabled = currentDocumentPage >= totalPages;
      
      prevBtn.onclick = () => navigatePageByScroll(-1);
      nextBtn.onclick = () => navigatePageByScroll(1);
      
      // Add scroll event listener to track progress
      setTimeout(() => {
        const scrollContainer = document.getElementById('scrollContainer');
        const scrollTracker = document.getElementById('scrollTracker');
        
        if (scrollContainer) {
          // Scroll to the initial position based on saved progress
          const initialScrollPosition = (currentDocumentPage - 1) / totalPages * 
            (scrollContainer.scrollHeight - scrollContainer.clientHeight);
          scrollContainer.scrollTop = initialScrollPosition;
          
          // Add scroll listener
          scrollContainer.addEventListener('scroll', function() {
            const scrollPercentage = scrollContainer.scrollTop / 
              (scrollContainer.scrollHeight - scrollContainer.clientHeight);
            
            // Calculate current page based on scroll percentage
            const estimatedPage = Math.min(
              Math.max(1, Math.ceil(scrollPercentage * totalPages)),
              totalPages
            );
            
            // Update the scroll tracker and page counter
            scrollTracker.textContent = `Page ${estimatedPage} of ${totalPages}`;
            document.getElementById('pageCounter').textContent = `Page ${estimatedPage} of ${totalPages}`;
            
            // Only update storage if the page has changed
            if (estimatedPage !== currentDocumentPage) {
              currentDocumentPage = estimatedPage;
              
              // Update navigation buttons
              document.getElementById('prevPage').disabled = currentDocumentPage <= 1;
              document.getElementById('nextPage').disabled = currentDocumentPage >= totalPages;
              
              // Calculate and store progress
              const progress = currentDocumentPage / totalPages;
              storeProgress(currentCourseId, currentLessonId, progress);
              updateDocumentProgressIndicator(progress * 100);
              updateDocumentCompletionButton(currentCourseId, currentLessonId);
            }
          }, { passive: true });
        }
      }, 1500); // Give the iframe time to load
    }

    // Function to navigate by scrolling
    function navigatePageByScroll(direction) {
      const scrollContainer = document.getElementById('scrollContainer');
      if (!scrollContainer) return;
      
      const newPage = currentDocumentPage + direction;
      if (newPage < 1 || newPage > totalPages) return;
      
      // Calculate the scroll position for the target page
      const pageHeight = scrollContainer.scrollHeight / totalPages;
      const targetScrollPosition = (newPage - 1) * pageHeight;
      
      // Smooth scroll to the position
      scrollContainer.scrollTo({
        top: targetScrollPosition,
        behavior: 'smooth'
      });
      
      // Page counter and progress updates will be handled by the scroll event listener
    }

    // Navigation functions for PowerPoint slides
    function navigateSlide(direction) {
      const newSlide = currentDocumentSlide + direction;
      
      if (newSlide < 1 || newSlide > totalSlides) {
        return;
      }
      
      currentDocumentSlide = newSlide;
      
      // Update UI
      document.getElementById('slideCounter').textContent = `Slide ${currentDocumentSlide} of ${totalSlides}`;
      
      // Reload iframe with new slide number
      const slideFrame = document.getElementById('slideFrame');
      const lesson = courses.find(c => c.id === currentCourseId)
        ?.lessons.find(l => l.id === currentLessonId);
      
      if (lesson) {
        slideFrame.innerHTML = `
          <iframe 
            src="https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(lesson.documentUrl)}&wdSlideId=${currentDocumentSlide}" 
            width="100%" 
            height="100%" 
            frameborder="0"
            class="w-full aspect-video">
          </iframe>
        `;
      }
      
      // Update navigation buttons
      document.getElementById('prevSlide').disabled = currentDocumentSlide <= 1;
      document.getElementById('nextSlide').disabled = currentDocumentSlide >= totalSlides;
      
      // Calculate and store progress
      const progress = currentDocumentSlide / totalSlides;
      storeProgress(currentCourseId, currentLessonId, progress);
      updateDocumentProgressIndicator(progress * 100);
      updateDocumentCompletionButton(currentCourseId, currentLessonId);
    }

    // Update progress indicator for documents
    function updateDocumentProgressIndicator(percent) {
      document.getElementById('progressPercent').textContent = `${Math.round(percent)}%`;
      document.getElementById('progressBar').style.width = `${percent}%`;
    }

    // Update completion button state
    function updateDocumentCompletionButton(courseId, lessonId) {
      const completed = isLessonCompleted(courseId, lessonId);
      const progress = getStoredProgress(courseId, lessonId);
      const completeBtn = document.getElementById('markDocumentCompletedButton');
      
      if (progress === 1 || completed) {
        completeBtn.disabled = true;
        completeBtn.classList.add('opacity-50', 'cursor-not-allowed');
        completeBtn.classList.remove('hover:bg-purple-700');
        completeBtn.innerHTML = completed ? 
          '<i class="fas fa-check-double mr-2"></i>Lesson Completed' : 
          '<i class="fas fa-check mr-2"></i>Already at 100%';
      } else {
        completeBtn.disabled = false;
        completeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        completeBtn.classList.add('hover:bg-purple-700');
        completeBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Mark as Completed';
      }
    }

    // Mark document completed function
    function markDocumentCompleted() {
      markLessonCompleted(currentCourseId, currentLessonId);
      closeDocument();
      renderCourses();
    }

    // Close document function
    function closeDocument() {
      document.getElementById('documentModal').classList.add('hidden');
      renderCourses();
    }

    // Update the createLessonButton function to handle different content types

    function createLessonButton(lesson, courseId, isEnrolled = true) {
      const isDone = isLessonCompleted(courseId, lesson.id);
      const lessonProgress = getStoredProgress(courseId, lesson.id) * 100;
      const isStarted = lessonProgress > 0 && !isDone;
      
      const button = document.createElement('button');
      button.className = `flex items-center justify-between w-full text-left p-3 rounded-lg transition-colors lesson-button
        ${isDone ? 'bg-green-50 text-green-800 hover:bg-green-100' : 
                  isStarted ? 'bg-blue-50 text-blue-800 hover:bg-blue-100' : 
                  'bg-gray-50 hover:bg-gray-100 text-gray-800'}`;
      button.dataset.lessonId = lesson.id;
      button.dataset.courseId = courseId;
      
      const leftSide = document.createElement('div');
      leftSide.className = "flex items-center";
      
      let icon;
      // Choose icon based on content type
      if (lesson.contentType === 'document') {
        if (lesson.documentType === 'powerpoint') {
          icon = isDone ? '<i class="fas fa-check-circle text-green-500 mr-3"></i>' : 
                 isStarted ? '<i class="fas fa-file-powerpoint text-blue-500 mr-3"></i>' :
                 '<i class="fas fa-file-powerpoint text-gray-300 mr-3"></i>';
        } else if (lesson.documentType === 'word') {
          icon = isDone ? '<i class="fas fa-check-circle text-green-500 mr-3"></i>' : 
                 isStarted ? '<i class="fas fa-file-word text-blue-500 mr-3"></i>' :
                 '<i class="fas fa-file-word text-gray-300 mr-3"></i>';
        }
      } else {
        // Default video icon
        icon = isDone ? '<i class="fas fa-check-circle text-green-500 mr-3"></i>' : 
               isStarted ? '<i class="fas fa-play-circle text-blue-500 mr-3"></i>' : 
               '<i class="fas fa-circle text-gray-300 mr-3"></i>';
      }
      
      leftSide.innerHTML = icon + `<span>${lesson.title}</span>`;
      
      const rightSide = document.createElement('div');
      rightSide.className = "flex items-center";
      
      const progressText = document.createElement('span');
      progressText.className = "text-xs mr-2";
      if (isDone) {
        progressText.textContent = "Completed";
        progressText.className += " text-green-600";
      } else if (isStarted) {
        progressText.textContent = `${lessonProgress.toFixed(0)}%`;
        progressText.className += " text-blue-600";
      }
      
      const arrowIcon = document.createElement('span');
      arrowIcon.className = "lesson-icon text-gray-400";
      arrowIcon.innerHTML = '<i class="fas fa-chevron-right"></i>';
      
      rightSide.appendChild(progressText);
      rightSide.appendChild(arrowIcon);
      
      button.appendChild(leftSide);
      button.appendChild(rightSide);
      
      if (isEnrolled) {
        // Choose appropriate open function based on content type
        button.onclick = () => {
          if (lesson.contentType === 'document') {
            openDocument(lesson);
          } else {
            openVideo(lesson);
          }
        };
      } else {
        button.disabled = true;
        button.classList.add('opacity-50', 'cursor-not-allowed');
        button.onclick = (e) => {
          e.preventDefault();
          alert('Please enroll in this course to access lessons');
        };
      }
      
      return button;
    }

    // Replace the existing populateCourseTree function with this corrected version
    function populateCourseTree() {
      const courseTreeList = document.getElementById('courseTreeList');
      courseTreeList.innerHTML = '';  // Clear existing content

      // Get current filter settings
      const showOnlyEnrolled = localStorage.getItem('courseTreeFilter') === 'enrolled';
      
      // Get all courses based on filter
      let displayCourses = [...courses];
      if (showOnlyEnrolled) {
        displayCourses = courses.filter(course => checkEnrollmentStatus(course.id));
      }
      
      // If empty after filtering
      if (displayCourses.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = "text-center py-4 text-sm text-gray-500";
        emptyState.innerHTML = `
          <i class="fas fa-folder-open text-gray-400 text-2xl mb-2"></i>
          <p>No courses found</p>
        `;
        courseTreeList.appendChild(emptyState);
        return;
      }

      // Create DOM elements for each course
      displayCourses.forEach(course => {
        const isEnrolled = checkEnrollmentStatus(course.id);
        
        // Course item
        const li = document.createElement('li');
        li.className = `course-tree-item mb-2 overflow-hidden ${isEnrolled ? 'enrolled pl-2' : 'pl-2'}`;
        li.dataset.courseId = course.id;
        
        // Course header
        const courseHeader = document.createElement('div');
        courseHeader.className = "flex items-center justify-between py-2 px-1 hover:bg-gray-50 rounded cursor-pointer";
        
        // Left side with toggle
        const leftSide = document.createElement('div');
        leftSide.className = "flex items-center flex-grow min-w-0";
        
        const toggleIcon = document.createElement('span');
        toggleIcon.className = "course-tree-toggle text-gray-400 mr-2";
        toggleIcon.innerHTML = '<i class="fas fa-chevron-right"></i>';
        
        const courseIcon = document.createElement('span');
        courseIcon.className = "mr-2";
        courseIcon.innerHTML = `<i class="fas fa-book ${isEnrolled ? 'text-brand-purple' : 'text-gray-400'}"></i>`;
        
        const courseTitle = document.createElement('span');
        courseTitle.className = "truncate font-medium text-sm";
        courseTitle.textContent = course.title;
        
        leftSide.appendChild(toggleIcon);
        leftSide.appendChild(courseIcon);
        leftSide.appendChild(courseTitle);
        
        courseHeader.appendChild(leftSide);
        
        // Lessons container (initially hidden)
        const lessonsContainer = document.createElement('div');
        lessonsContainer.className = "course-tree-lessons ml-4";
        
        // Create lesson items for this course
        course.lessons.forEach(lesson => {
          const lessonCompleted = isLessonCompleted(course.id, lesson.id);
          const lessonProgress = getStoredProgress(course.id, lesson.id) * 100;
          const lessonStarted = lessonProgress > 0 && !lessonCompleted;
          
          const lessonItem = document.createElement('div');
          lessonItem.className = `course-tree-lesson flex items-center justify-between py-1.5 px-2 hover:bg-gray-50 ${!isEnrolled ? 'opacity-50' : ''}`;
          lessonItem.dataset.lessonId = lesson.id;
          
          // Lesson title with status icon
          const lessonLeft = document.createElement('div');
          lessonLeft.className = "flex items-center flex-grow min-w-0";
          
          let statusIcon;
          if (lessonCompleted) {
            statusIcon = '<i class="fas fa-check-circle text-green-500 mr-2"></i>';
          } else if (lessonStarted) {
            if (lesson.contentType === 'document') {
              if (lesson.documentType === 'powerpoint') {
                statusIcon = '<i class="fas fa-file-powerpoint text-blue-500 mr-2"></i>';
              } else if (lesson.documentType === 'word') {
                statusIcon = '<i class="fas fa-file-word text-blue-500 mr-2"></i>';
              } else {
                statusIcon = '<i class="fas fa-file-alt text-blue-500 mr-2"></i>';
              }
            } else {
              statusIcon = '<i class="fas fa-play-circle text-blue-500 mr-2"></i>';
            }
          } else {
            if (lesson.contentType === 'document') {
              if (lesson.documentType === 'powerpoint') {
                statusIcon = '<i class="fas fa-file-powerpoint text-gray-300 mr-2"></i>';
              } else if (lesson.documentType === 'word') {
                statusIcon = '<i class="fas fa-file-word text-gray-300 mr-2"></i>';
              } else {
                statusIcon = '<i class="fas fa-file-alt text-gray-300 mr-2"></i>';
              }
            } else {
              statusIcon = '<i class="fas fa-circle text-gray-300 mr-2"></i>';
            }
          }
          
          lessonLeft.innerHTML = `${statusIcon}<span class="truncate text-sm">${lesson.title}</span>`;
          
          lessonItem.appendChild(lessonLeft);
          
          // Add click handler to open the lesson
          if (isEnrolled) {
            lessonItem.classList.add('cursor-pointer');
            lessonItem.addEventListener('click', () => {
              const lessonObj = course.lessons.find(l => l.id === lesson.id);
              if (lessonObj) {
                if (lessonObj.contentType === 'document') {
                  openDocument(lessonObj);
                } else {
                  openVideo(lessonObj);
                }
              }
            });
          }
          
          lessonsContainer.appendChild(lessonItem);
        });
        
        // Add toggle functionality
        courseHeader.addEventListener('click', () => {
          toggleIcon.classList.toggle('rotated');
          lessonsContainer.classList.toggle('expanded');
        });
        
        li.appendChild(courseHeader);
        li.appendChild(lessonsContainer);
        
        courseTreeList.appendChild(li);
      });
    }

    // Add required setup course tree controls function if it's missing
    function setupCourseTreeControls() {
      // Filter buttons
      const allFilterBtn = document.getElementById('filterAllCourses');
      const enrolledFilterBtn = document.getElementById('filterEnrolledCourses');
      
      if (!allFilterBtn || !enrolledFilterBtn) {
        console.error("Filter buttons not found in the DOM");
        return;
      }
      
      // Set initial state from localStorage
      const currentFilter = localStorage.getItem('courseTreeFilter') || 'all';
      if (currentFilter === 'enrolled') {
        allFilterBtn.classList.remove('active');
        enrolledFilterBtn.classList.add('active');
      } else {
        allFilterBtn.classList.add('active');
        enrolledFilterBtn.classList.remove('active');
      }
      
      // All courses filter
      allFilterBtn.addEventListener('click', () => {
        allFilterBtn.classList.add('active');
        enrolledFilterBtn.classList.remove('active');
        localStorage.setItem('courseTreeFilter', 'all');
        populateCourseTree();
      });
      
      // Enrolled courses filter
      enrolledFilterBtn.addEventListener('click', () => {
        enrolledFilterBtn.classList.add('active');
        allFilterBtn.classList.remove('active');
        localStorage.setItem('courseTreeFilter', 'enrolled');
        populateCourseTree();
      });
    }

    // Make sure we have a simple sidebar toggle function
    function setupSidebarToggle() {
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const expandButton = document.getElementById('expandButton');
      
      if (!sidebar || !sidebarToggle || !expandButton) {
        console.error("Sidebar elements not found in the DOM");
        return;
      }
      
      // Toggle sidebar collapsed state
      sidebarToggle.addEventListener('click', function() {
        sidebar.classList.add('collapsed');
        expandButton.classList.add('visible');
        localStorage.setItem('sidebarCollapsed', 'true');
      });
      
      // Expand sidebar when clicking expand button
      expandButton.addEventListener('click', function() {
        sidebar.classList.remove('collapsed');
        expandButton.classList.remove('visible');
        localStorage.setItem('sidebarCollapsed', 'false');
      });
      
      // Check for saved state
      if (localStorage.getItem('sidebarCollapsed') === 'true') {
        sidebar.classList.add('collapsed');
        expandButton.classList.add('visible');
      }
    }

    // Configuration object with full YouTube URLs and document content
    const platformConfig = {
      title: "Learning Platform",
      pageTitle: "My Learning",
      courses: [
        {
          id: "course-1",
          title: "Python Basics",
          description: "Learn the fundamentals of Python programming with hands-on projects and exercises.",
          image: "https://images.unsplash.com/photo-1649180556628-9ba704115795?q=80&w=3262&auto=format&fit=crop&ixlib=rb-4.0.3",
          instructor: "Alex Johnson",
          duration: "8 hours",
          lessons: [
            { 
              id: "lesson-1", 
              title: "Introduction to Python", 
              contentType: "video",
              videoUrl: "https://www.youtube.com/watch?v=K5KVEU3aaeQ"
            },
            { 
              id: "lesson-2", 
              title: "Python Syntax Guide", 
              contentType: "document",
              documentType: "powerpoint",
              documentUrl: "https://sample-videos.com/ppt/Sample-PPT-File-1000kb.ppt", 
              totalSlides: 17
            },
            { 
              id: "lesson-3", 
              title: "Control Flow and Loops", 
              contentType: "video",
              videoUrl: "https://www.youtube.com/watch?v=6iF8Xb7Z3wQ"
            }
          ]
        },
        {
          id: "course-2",
          title: "JavaScript Essentials",
          description: "Master the basics of JavaScript including DOM manipulation, events, and modern ES6+ features.",
          image: "https://images.unsplash.com/photo-1579468118864-1b9ea3c0db4a?q=80&w=3270&auto=format&fit=crop&ixlib=rb-4.0.3",
          instructor: "Maria Garcia",
          duration: "6.5 hours",
          lessons: [
            { 
              id: "lesson-4", 
              title: "JavaScript Fundamentals", 
              contentType: "video",
              videoUrl: "https://sample-videos.com/video321/mp4/720/big_buck_bunny_720p_1mb.mp4" 
            },
            { 
              id: "lesson-5", 
              title: "Working with the DOM", 
              contentType: "document",
              documentType: "word",
              documentUrl: "https://sample-videos.com/doc/Sample-doc-file-200kb.doc",
              pageCount: 31
            }
          ]
        }
      ]
    };

    // Initialize the courses variable by extracting it from platformConfig
    const courses = platformConfig.courses;

    // Main data store object
    let dataStore = null;

    // Add variables to track current course and lesson
    let currentCourseId = "";
    let currentLessonId = "";

    // Global reference to YouTube player
    let youtubePlayer = null;

    // Variable to store YouTube progress tracking interval
    let youtubeProgressInterval = null;

    // Create empty data store structure
    function createEmptyDataStore() {
      return {
        courses: {},
        lastUpdated: Date.now()
      };
    }

    // Save the entire data store
    function saveDataStore() {
      if (dataStore) {
        dataStore.lastUpdated = Date.now();
        localStorage.setItem('learningData', JSON.stringify(dataStore));
      }
    }
    
    // ADD MISSING DOCUMENT READY EVENT HANDLER to initialize the platform
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('navTitle').textContent = platformConfig.title;
      document.getElementById('platformTitle').textContent = platformConfig.pageTitle;
      document.title = platformConfig.title;
      
      // Set up navigation buttons
      document.getElementById('showAllCoursesBtn').addEventListener('click', showAllCourses);
      document.getElementById('showMyProgressBtn').addEventListener('click', showMyProgress);
      
      // Fix: Initialize setupCourseTreeControls and populateCourseTree
      setupCourseTreeControls();
      populateCourseTree();
      
      setupSearch(); // Initialize search functionality
      
      // IMPORTANT - call renderCourses to display course cards
      renderCourses();
      
      // Add active-nav-item styling
      document.head.insertAdjacentHTML('beforeend', `
        <style>
          .active-nav-item {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #111827 !important;
          }
        </style>
      `);

      // Add this line:
      setupSidebarToggle();
    });

    // Ensure renderCourses function is complete

    function renderCourses() {
      const container = document.getElementById('courses');
      
      // Make sure container exists
      if (!container) {
        console.error("Courses container not found in the DOM");
        return;
      }
      
      container.innerHTML = '';

      // Check if courses array exists and has content
      if (!courses || courses.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-10">
            <div class="text-gray-400 mb-4"><i class="fas fa-book-open text-5xl"></i></div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">No Courses Available</h3>
            <p class="text-gray-500">There are currently no courses available.</p>
          </div>
        `;
        return;
      }

      // Use DocumentFragment for better performance
      const fragment = document.createDocumentFragment();

      courses.forEach(course => {
        fragment.appendChild(createCourseCard(course));
      });

      container.appendChild(fragment);
    }

    // Add these navigation functions

    // Navigation functions
    function showAllCourses() {
      document.getElementById('allCoursesPage').classList.remove('hidden');
      document.getElementById('allCoursesPage').classList.add('block');
      document.getElementById('myProgressPage').classList.add('hidden');
      document.getElementById('myProgressPage').classList.remove('block');
      
      // Update active navigation item
      document.getElementById('showAllCoursesBtn').classList.add('active-nav-item');
      document.getElementById('showMyProgressBtn').classList.remove('active-nav-item');
    }

    function showMyProgress() {
      document.getElementById('allCoursesPage').classList.add('hidden');
      document.getElementById('allCoursesPage').classList.remove('block');
      document.getElementById('myProgressPage').classList.remove('hidden');
      document.getElementById('myProgressPage').classList.add('block');
      
      // Update active navigation item
      document.getElementById('showAllCoursesBtn').classList.remove('active-nav-item');
      document.getElementById('showMyProgressBtn').classList.add('active-nav-item');
      
      // Update progress statistics
      renderProgressPage();
    }

    // Setup search functionality
    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      const clearSearch = document.getElementById('clearSearch');
      
      if (searchInput && clearSearch) {
        searchInput.addEventListener('input', function() {
          const query = this.value.toLowerCase().trim();
          
          // Show/hide clear button
          if (query) {
            clearSearch.classList.remove('hidden');
          } else {
            clearSearch.classList.add('hidden');
          }
          
          // Filter courses
          performSearch(query);
        });
        
        clearSearch.addEventListener('click', function() {
          searchInput.value = '';
          this.classList.add('hidden');
          performSearch('');
        });
      }
      
      // Also set up the course tree search
      const treeSearch = document.getElementById('courseTreeSearch');
      const clearTreeSearch = document.getElementById('clearTreeSearch');
      
      if (treeSearch && clearTreeSearch) {
        treeSearch.addEventListener('input', function() {
          const query = this.value.toLowerCase().trim();
          
          // Show/hide clear button
          if (query) {
            clearTreeSearch.classList.remove('hidden');
          } else {
            clearTreeSearch.classList.add('hidden');
          }
          
          // Filter course tree
          filterCourseTree(query);
        });
        
        clearTreeSearch.addEventListener('click', function() {
          treeSearch.value = '';
          this.classList.add('hidden');
          filterCourseTree('');
        });
      }
    }

    // Function to search and filter courses
    function performSearch(query) {
      // Normalize query to lowercase and trim
      query = query.toLowerCase().trim();
      
      // Get all course cards and reset them first
      const courseCards = document.querySelectorAll('.course-card');
      
      // If query is empty, show all courses
      if (!query) {
        courseCards.forEach(card => {
          card.classList.remove('hidden');
          card.classList.remove('ring-2', 'ring-brand-purple', 'ring-opacity-50');
          
          // Reset lesson highlighting
          const lessonButtons = card.querySelectorAll('button[data-lesson-id]');
          lessonButtons.forEach(button => {
            button.classList.remove('ring-2', 'ring-brand-purple', 'ring-opacity-50');
          });
        });
        
        // Show the original heading
        document.getElementById('platformTitle').textContent = platformConfig.pageTitle;
        
        const subheadingElement = document.querySelector('.flex.items-center.justify-between.flex-wrap p.text-gray-600');
        if (subheadingElement) {
          subheadingElement.textContent = "Continue learning where you left off";
        }
        return;
      }
      
      // Update the heading to show search results
      document.getElementById('platformTitle').textContent = `Search results for "${query}"`;
      
      const subheadingElement = document.querySelector('.flex.items-center.justify-between.flex-wrap p.text-gray-600');
      if (subheadingElement) {
        subheadingElement.textContent = "Courses and lessons matching your search";
      }
      
      // Track matches to update the UI appropriately
      let matchCount = 0;
      
      courseCards.forEach(card => {
        const courseId = card.dataset.courseId;
        const course = courses.find(c => c.id === courseId);
        const courseTitle = card.querySelector('h2').textContent.toLowerCase();
        const courseDescription = card.querySelector('p.text-gray-700').textContent.toLowerCase();
        
        // Check course title and description
        const titleMatch = courseTitle.includes(query);
        const descMatch = courseDescription.includes(query);
        const courseMatches = titleMatch || descMatch;
        
        // Get all lesson buttons in this course
        const lessonButtons = card.querySelectorAll('button[data-lesson-id]');
        let hasMatchingLesson = false;
        
        // Check if any lesson title matches
        lessonButtons.forEach(button => {
          const lessonId = button.dataset.lessonId;
          const lesson = course.lessons.find(l => l.id === lessonId);
          const lessonTitle = lesson.title.toLowerCase();
          
          if (lessonTitle.includes(query)) {
            // Highlight matching lesson
            button.classList.add('ring-2', 'ring-brand-purple', 'ring-opacity-50');
            hasMatchingLesson = true;
          } else {
            // Remove highlight if not matching
            button.classList.remove('ring-2', 'ring-brand-purple', 'ring-opacity-50');
          }
        });
        
        // Show course if title, description or any lesson matches
        if (courseMatches || hasMatchingLesson) {
          card.classList.remove('hidden');
          matchCount++;
          
          if (courseMatches) {
            card.classList.add('ring-2', 'ring-brand-purple', 'ring-opacity-50');
          } else {
            card.classList.remove('ring-2', 'ring-brand-purple', 'ring-opacity-50');
          }
        } else {
          card.classList.add('hidden');
        }
      });
      
      if (matchCount === 0) {
        document.getElementById('platformTitle').textContent = "No results found";
        
        if (subheadingElement) {
          subheadingElement.textContent = `No courses or lessons match "${query}"`;
        }
      }
    }

    // Function to filter the course tree
    function filterCourseTree(query) {
      // Normalize query to lowercase and trim
      query = query.toLowerCase().trim();
      
      const courseItems = document.querySelectorAll('#courseTreeList > li');
      let anyMatches = false;
      
      courseItems.forEach(courseItem => {
        const courseId = courseItem.dataset.courseId;
        const course = courses.find(c => c.id === courseId);
        
        // Check course title
        const courseTitle = courseItem.querySelector('.course-tree-item > div > div > span:nth-child(3)').textContent.toLowerCase();
        
        // Get course description from data
        const courseDescription = course.description.toLowerCase();
        
        // Check if course title or description matches
        const courseMatches = courseTitle.includes(query) || courseDescription.includes(query);
        
        // Check lesson titles
        const lessonItems = courseItem.querySelectorAll('.course-tree-lesson');
        let lessonMatches = false;
        
        lessonItems.forEach(lessonItem => {
          const lessonId = lessonItem.dataset.lessonId;
          const lesson = course.lessons.find(l => l.id === lessonId);
          const lessonText = lessonItem.querySelector('span').textContent.toLowerCase();
          
          if (lessonText.includes(query)) {
            lessonItem.classList.add('bg-gray-100', 'ring-1', 'ring-brand-purple', 'ring-opacity-50');
            lessonMatches = true;
          } else {
            lessonItem.classList.remove('bg-gray-100', 'ring-1', 'ring-brand-purple', 'ring-opacity-50');
          }
        });
        
        if (courseMatches || lessonMatches || query === '') {
          courseItem.classList.remove('hidden');
          anyMatches = true;
          
          if (courseMatches) {
            courseItem.querySelector('.course-tree-item > div').classList.add('bg-gray-100', 'ring-1', 'ring-brand-purple', 'ring-opacity-50');
          } else {
            courseItem.querySelector('.course-tree-item > div').classList.remove('bg-gray-100', 'ring-1', 'ring-brand-purple', 'ring-opacity-50');
          }
          
          if (query !== '' && (courseMatches || lessonMatches)) {
            const toggleIcon = courseItem.querySelector('.course-tree-toggle');
            const lessonsContainer = courseItem.querySelector('.course-tree-lessons');
            
            toggleIcon.classList.add('rotated');
            lessonsContainer.classList.add('expanded');
          }
        } else {
          courseItem.classList.add('hidden');
        }
      });
      
      const noResultsEl = document.getElementById('courseTreeNoResults');
      if (!anyMatches && query !== '') {
        if (!noResultsEl) {
          const noResults = document.createElement('div');
          noResults.id = 'courseTreeNoResults';
          noResults.className = "text-center py-4 text-sm text-gray-500";
          noResults.innerHTML = `
            <i class="fas fa-search text-gray-400 text-xl mb-2"></i>
            <p>No matches found for "${query}"</p>
          `;
          document.getElementById('courseTreeList').appendChild(noResults);
        } else {
          noResultsEl.innerHTML = `
            <i class="fas fa-search text-gray-400 text-xl mb-2"></i>
            <p>No matches found for "${query}"</p>
          `;
          noResultsEl.classList.remove('hidden');
        }
      } else if (noResultsEl) {
        noResultsEl.classList.add('hidden');
      }
    }

    // Function to render progress page
    function renderProgressPage() {
      let coursesInProgress = 0;
      let lessonsCompleted = 0;
      let totalLessons = 0;
      
      // Get enrolled courses
      const enrolledCourseIds = getEnrolledCourseIds();
      
      // Reset the progress list
      const courseProgressList = document.getElementById('courseProgressList');
      courseProgressList.innerHTML = '';
      
      // Check if user has any enrolled courses
      if (enrolledCourseIds.length === 0) {
        const noCourseMessage = document.createElement('div');
        noCourseMessage.className = "bg-white p-8 rounded-lg shadow text-center";
        noCourseMessage.innerHTML = `
          <div class="text-gray-400 mb-4"><i class="fas fa-book-reader text-5xl"></i></div>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">No Enrolled Courses</h3>
          <p class="text-gray-500 mb-4">You haven't enrolled in any courses yet.</p>
          <button id="browseCourses" class="bg-brand-purple hover:bg-purple-700 text-white px-6 py-2 rounded-md">
            Browse Courses
          </button>
        `;
        
        courseProgressList.appendChild(noCourseMessage);
        
        document.getElementById('browseCourses').addEventListener('click', showAllCourses);
        
        document.getElementById('coursesInProgressCount').textContent = 0;
        document.getElementById('lessonsCompletedCount').textContent = 0;
        document.getElementById('overallProgressPercent').textContent = "0%";
        
        return;
      }
      
      // Process enrolled courses
      courses.forEach(course => {
        if (!enrolledCourseIds.includes(course.id)) {
          return;
        }
        
        totalLessons += course.lessons.length;
        const completedLessonsCount = getCompletedLessons(course).length;
        lessonsCompleted += completedLessonsCount;
        
        const progress = calculateCourseProgress(course);
        if (progress > 0 && progress < 100) {
          coursesInProgress++;
        }
        
        // Create course progress card - code for rendering course progress cards...
        // Implementation details omitted for brevity
      });
      
      // Update stats
      document.getElementById('coursesInProgressCount').textContent = coursesInProgress;
      document.getElementById('lessonsCompletedCount').textContent = lessonsCompleted;
      
      const overallPercent = totalLessons > 0 ? ((lessonsCompleted / totalLessons) * 100).toFixed(0) : 0;
      document.getElementById('overallProgressPercent').textContent = `${overallPercent}%`;
    }

    // Data access helper functions
    function checkEnrollmentStatus(courseId) {
      const store = getDataStore();
      if (!store.courses[courseId]) {
        return false;
      }
      return store.courses[courseId].enrolled === true;
    }

    function getEnrolledCourseIds() {
      const store = getDataStore();
      return Object.keys(store.courses).filter(courseId => store.courses[courseId].enrolled === true);
    }

    function isLessonCompleted(courseId, lessonId) {
      const store = getDataStore();
      if (!store.courses[courseId] || !store.courses[courseId].lessons) {
        return false;
      }
      return store.courses[courseId].lessons[lessonId]?.completed === true;
    }

    function getStoredProgress(courseId, lessonId) {
      const store = getDataStore();
      if (!store.courses[courseId] || !store.courses[courseId].lessons) {
        return 0;
      }
      return store.courses[courseId].lessons[lessonId]?.progress || 0;
    }

    function storeProgress(courseId, lessonId, ratio) {
      const store = getDataStore();
      
      // Initialize course object if it doesn't exist
      if (!store.courses[courseId]) {
        store.courses[courseId] = { lessons: {} };
      }
      
      // Initialize lessons object if it doesn't exist
      if (!store.courses[courseId].lessons) {
        store.courses[courseId].lessons = {};
      }
      
      // Initialize lesson object if it doesn't exist
      if (!store.courses[courseId].lessons[lessonId]) {
        store.courses[courseId].lessons[lessonId] = {};
      }
      
      // Store progress ratio
      store.courses[courseId].lessons[lessonId].progress = ratio;
      
      // Auto-complete if 100% progress
      if (ratio >= 1) {
        store.courses[courseId].lessons[lessonId].completed = true;
      }
      
      // Save data
      saveDataStore();
    }

    function markLessonCompleted(courseId, lessonId) {
      const store = getDataStore();
      
      // Initialize course object if it doesn't exist
      if (!store.courses[courseId]) {
        store.courses[courseId] = { lessons: {} };
      }
      
      // Initialize lessons object if it doesn't exist
      if (!store.courses[courseId].lessons) {
        store.courses[courseId].lessons = {};
      }
      
      // Initialize lesson object if it doesn't exist
      if (!store.courses[courseId].lessons[lessonId]) {
        store.courses[courseId].lessons[lessonId] = {};
      }
      
      // Mark as completed
      store.courses[courseId].lessons[lessonId].completed = true;
      store.courses[courseId].lessons[lessonId].progress = 1;
      store.courses[courseId].lessons[lessonId].completedAt = Date.now();
      
      // Save data
      saveDataStore();
    }

    function getCompletedLessons(course) {
      const completedLessons = [];
      const store = getDataStore();
      
      if (!store.courses[course.id] || !store.courses[course.id].lessons) {
        return completedLessons;
      }
      
      course.lessons.forEach(lesson => {
        if (isLessonCompleted(course.id, lesson.id)) {
          completedLessons.push(lesson.id);
        }
      });
      
      return completedLessons;
    }

    function calculateCourseProgress(course) {
      const totalLessons = course.lessons.length;
      if (totalLessons === 0) return 0;
      
      const completedCount = getCompletedLessons(course).length;
      return (completedCount / totalLessons) * 100;
    }

    function enrollInCourse(courseId) {
      const store = getDataStore();
      
      // Initialize course object if it doesn't exist
      if (!store.courses[courseId]) {
        store.courses[courseId] = { lessons: {} };
      }
      
      // Mark as enrolled
      store.courses[courseId].enrolled = true;
      store.courses[courseId].enrolledAt = Date.now();
      
      // Save data
      saveDataStore();
      
      // Update UI
      renderCourses();
      populateCourseTree();
      
      // Show message
      showToast('You have successfully enrolled in the course', 'success');
    }

    function unenrollFromCourse(courseId) {
      const store = getDataStore();
      
      if (!store.courses[courseId]) {
        return;
      }
      
      // Ask for confirmation before unenrolling
      if (confirm("Are you sure you want to unenroll from this course? Your progress will be preserved, but the course will be removed from your active courses.")) {
        // Mark as not enrolled
        store.courses[courseId].enrolled = false;
        
        // Save data
        saveDataStore();
        
        // Update UI
        renderCourses();
        populateCourseTree();
        
        // Show message
        showToast('You have unenrolled from the course', 'info');
      }
    }

    // Helper function to show toast notifications
    function showToast(message, type = 'info') {
      // Create toast container if it doesn't exist
      let container = document.getElementById('toastContainer');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'fixed bottom-4 right-4 z-50 flex flex-col gap-2';
        document.body.appendChild(container);
      }
      
      // Create toast
      const toast = document.createElement('div');
      
      // Set appearance based on type
      let bgColor, textColor, icon;
      switch (type) {
        case 'success':
          bgColor = 'bg-green-500';
          textColor = 'text-white';
          icon = '<i class="fas fa-check-circle mr-2"></i>';
          break;
        case 'warning':
          bgColor = 'bg-yellow-500';
          textColor = 'text-white';
          icon = '<i class="fas fa-exclamation-triangle mr-2"></i>';
          break;
        case 'error':
          bgColor = 'bg-red-500';
          textColor = 'text-white';
          icon = '<i class="fas fa-exclamation-circle mr-2"></i>';
          break;
        default:
          bgColor = 'bg-blue-500';
          textColor = 'text-white';
          icon = '<i class="fas fa-info-circle mr-2"></i>';
      }
      
      toast.className = `${bgColor} ${textColor} py-2 px-4 rounded-md shadow-lg flex items-center animate-fade-in max-w-xs`;
      toast.innerHTML = `${icon}${message}`;
      container.appendChild(toast);
      
      // Remove after 3 seconds
      setTimeout(() => {
        toast.classList.add('animate-fade-out');
        setTimeout(() => {
          if (container.contains(toast)) {
            container.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    // Add to your style block
    document.head.insertAdjacentHTML('beforeend', `
      <style>
        .animate-fade-in {
          animation: fadeIn 0.3s ease-in-out;
        }
        .animate-fade-out {
          animation: fadeOut 0.3s ease-in-out;
        }
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
          from { opacity: 1; transform: translateY(0); }
          to { opacity: 0; transform: translateY(10px); }
        }
      </style>
    `);

    // Function to create a course card
    function createCourseCard(course) {
      const courseCard = document.createElement('div');
      courseCard.className = "bg-white rounded-lg shadow-md overflow-hidden flex flex-col course-card border border-gray-200";
      courseCard.dataset.courseId = course.id;

      const completedLessons = getCompletedLessons(course);
      const progress = calculateCourseProgress(course);
      const isInProgress = progress > 0;
      const isEnrolled = checkEnrollmentStatus(course.id);
      
      const img = document.createElement('img');
      img.src = course.image;
      img.alt = course.title;
      img.className = "h-48 w-full object-cover";
      
      // Add enrollment badge if enrolled
      if (isEnrolled) {
        const enrolledBadge = document.createElement('div');
        enrolledBadge.className = "absolute top-2 right-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full";
        enrolledBadge.innerHTML = '<i class="fas fa-user-check mr-1"></i>Enrolled';
        
        // Make img container relative for absolute positioning of badge
        const imgContainer = document.createElement('div');
        imgContainer.className = "relative";
        imgContainer.appendChild(img);
        imgContainer.appendChild(enrolledBadge);
        courseCard.appendChild(imgContainer);
      } else {
        courseCard.appendChild(img);
      }
      
      const content = document.createElement('div');
      content.className = "p-5 flex flex-col flex-1 border-t border-gray-100";
      
      const title = document.createElement('h2');
      title.className = "text-xl font-bold mb-2 text-gray-800 leading-tight course-title";
      title.textContent = course.title;
      
      const instructor = document.createElement('p');
      instructor.className = "text-sm text-gray-600 mb-1";
      instructor.innerHTML = `<i class="fas fa-user-tie mr-2"></i>${course.instructor}`;
      
      const duration = document.createElement('p');
      duration.className = "text-sm text-gray-600 mb-3";
      duration.innerHTML = `<i class="fas fa-clock mr-2"></i>${course.duration} total`;
      
      const desc = document.createElement('p');
      desc.className = "text-gray-700 text-sm mb-4 flex-grow course-description";
      desc.textContent = course.description;
      
      // Enroll/Unenroll button
      const enrollButtonContainer = document.createElement('div');
      enrollButtonContainer.className = "mb-4";
      
      const enrollButton = document.createElement('button');
      
      if (isEnrolled) {
        enrollButton.className = "w-full py-2 px-4 bg-red-50 text-red-600 border border-red-200 rounded hover:bg-red-100 transition-colors";
        enrollButton.innerHTML = '<i class="fas fa-user-minus mr-2"></i>Unenroll';
        enrollButton.onclick = () => unenrollFromCourse(course.id);
      } else {
        enrollButton.className = "w-full py-2 px-4 bg-brand-purple text-white rounded hover:bg-purple-700 transition-colors";
        enrollButton.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Enroll in Course';
        enrollButton.onclick = () => enrollInCourse(course.id);
      }
      
      enrollButtonContainer.appendChild(enrollButton);
      content.appendChild(title);
      content.appendChild(instructor);
      content.appendChild(duration);
      content.appendChild(desc);
      content.appendChild(enrollButtonContainer);
      
      // Add divider
      const divider = document.createElement('hr');
      divider.className = "border-gray-200 mb-4";
      content.appendChild(divider);
      
      // Progress section - only show if enrolled
      if (isEnrolled) {
        const progressContainer = document.createElement('div');
        
        const progressLabel = document.createElement('div');
        progressLabel.className = "flex justify-between mb-1";
        
        const progressText = document.createElement('span');
        progressText.className = "text-sm font-medium text-gray-700";
        progressText.textContent = isInProgress ? "Continue learning" : "Start learning";
        
        const progressPercentage = document.createElement('span');
        progressPercentage.className = "text-sm font-medium text-gray-700";
        progressPercentage.textContent = `${progress.toFixed(0)}%`;
        
        progressLabel.appendChild(progressText);
        progressLabel.appendChild(progressPercentage);
        
        const progressBar = document.createElement('div');
        progressBar.className = "w-full bg-gray-200 rounded-full h-2.5";
        
        const progressFill = document.createElement('div');
        progressFill.className = `bg-brand-purple h-2.5 rounded-full ${progress > 0 && progress < 100 ? 'progress-bar-animated' : ''}`;
        progressFill.style.width = `${progress}%`;
        
        progressBar.appendChild(progressFill);
        progressContainer.appendChild(progressLabel);
        progressContainer.appendChild(progressBar);
        
        const stats = document.createElement('p');
        stats.className = "text-sm text-gray-500 mt-1 mb-4";
        stats.textContent = `${completedLessons.length} of ${course.lessons.length} lessons completed`;
        
        progressContainer.appendChild(stats);
        content.appendChild(progressContainer);
      }
      
      // Course content section - show for all courses but lessons are disabled for non-enrolled
      const lessonsContainer = document.createElement('div');
      lessonsContainer.className = "relative";
      
      const lessonsHeader = document.createElement('div');
      lessonsHeader.className = "flex justify-between items-center mb-3";
      
      const lessonsTitle = document.createElement('h3');
      lessonsTitle.className = "font-semibold text-gray-700";
      lessonsTitle.textContent = "Course Content";
      
      const lessonsCount = document.createElement('span');
      lessonsCount.className = "text-xs text-gray-500";
      lessonsCount.textContent = `${course.lessons.length} lessons`;
      
      lessonsHeader.appendChild(lessonsTitle);
      lessonsHeader.appendChild(lessonsCount);
      lessonsContainer.appendChild(lessonsHeader);
      
      const lessonsList = document.createElement('div');
      lessonsList.className = "space-y-2 pr-1 max-h-48 always-show-scrollbar";
      
      // Add lessons to demonstrate scrolling
      course.lessons.forEach(lesson => {
        lessonsList.appendChild(createLessonButton(lesson, course.id, isEnrolled));
      });
      
      // For browsers that don't show scrollbars by default
      if (course.lessons.length < 3) {
        const spacer = document.createElement('div');
        spacer.style.height = "4rem";
        lessonsList.appendChild(spacer);
      }
      
      lessonsContainer.appendChild(lessonsList);
      content.appendChild(lessonsContainer);
      
      // Only add enrollment message overlay for non-enrolled courses
      if (!isEnrolled) {
        const enrollOverlay = document.createElement('div');
        enrollOverlay.className = "mt-2 text-center";
        enrollOverlay.innerHTML = `
          <div class="text-xs text-gray-500 py-2 bg-gray-50 border border-gray-100 rounded-md">
            <i class="fas fa-lock text-gray-400 mr-1"></i>
            Enroll to access these lessons
          </div>
        `;
        content.appendChild(enrollOverlay);
      }
      
      courseCard.appendChild(content);
      
      return courseCard;
    }

    // Add video player functions if they're missing

    // Video handling functions
    function openVideo(lesson) {
      // Find the course this lesson belongs to
      const course = courses.find(c => c.lessons.some(l => l.id === lesson.id));
      const courseId = course ? course.id : null;
      
      if (!courseId) {
        console.error("Could not find course for lesson:", lesson);
        return;
      }
      
      // Check enrollment
      if (!checkEnrollmentStatus(courseId)) {
        showToast('Please enroll in this course to view lessons', 'warning');
        return;
      }
      
      // Set current lesson and course IDs
      currentLessonId = lesson.id;
      currentCourseId = courseId;
      
      // Set lesson title
      document.getElementById('lessonTitle').textContent = lesson.title;
      
      // Show video modal
      document.getElementById('videoModal').classList.remove('hidden');
      
      // Hide both players initially
      document.getElementById('lessonVideo').classList.add('hidden');
      document.getElementById('youtubeContainer').classList.add('hidden');
      
      // Get progress data
      const progress = getStoredProgress(courseId, lesson.id);
      
      // Handle YouTube or regular video
      if (lesson.videoUrl && lesson.videoUrl.includes('youtube.com')) {
        loadYouTubeVideo(lesson.videoUrl, progress);
      } else if (lesson.videoUrl) {
        loadRegularVideo(lesson.videoUrl, progress);
      }
      
      // Update completion button
      updateCompletionButton(courseId, lesson.id);
    }

    function loadYouTubeVideo(url, progress) {
      const youtubeContainer = document.getElementById('youtubeContainer');
      youtubeContainer.classList.remove('hidden');
      
      // Extract YouTube video ID
      const videoId = getYouTubeVideoId(url);
      
      if (!videoId) {
        console.error("Invalid YouTube URL:", url);
        return;
      }
      
      // If YouTube API is not loaded yet, wait for it
      if (typeof YT === 'undefined' || !YT.loaded) {
        // Add YouTube API script if it doesn't exist
        if (!document.getElementById('youtube-api')) {
          const tag = document.createElement('script');
          tag.id = 'youtube-api';
          tag.src = 'https://www.youtube.com/iframe_api';
          const firstScriptTag = document.getElementsByTagName('script')[0];
          firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
          
          // Set up callback for when API is ready
          window.onYouTubeIframeAPIReady = function() {
            createYouTubePlayer(videoId, progress);
          };
        } else {
          // If script is already there but not loaded yet
          window.onYouTubeIframeAPIReady = function() {
            createYouTubePlayer(videoId, progress);
          };
        }
      } else {
        // YouTube API is already loaded
        createYouTubePlayer(videoId, progress);
      }
    }

    function createYouTubePlayer(videoId, progress) {
      // If player already exists, destroy it
      if (youtubePlayer) {
        youtubePlayer.destroy();
      }
      
      const startTime = progress > 0 ? Math.floor(progress * getYouTubeVideoDuration(videoId)) : 0;
      
      youtubePlayer = new YT.Player('youtubePlayer', {
        videoId: videoId,
        playerVars: {
          'autoplay': 1,
          'start': startTime,
          'rel': 0,
          'modestbranding': 1
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    }

    function onPlayerReady(event) {
      // Setup progress tracking interval
      if (youtubeProgressInterval) {
        clearInterval(youtubeProgressInterval);
      }
      
      youtubeProgressInterval = setInterval(() => {
        if (youtubePlayer && youtubePlayer.getCurrentTime) {
          const currentTime = youtubePlayer.getCurrentTime();
          const duration = youtubePlayer.getDuration();
          const progress = currentTime / duration;
          
          // Store progress if we have valid values
          if (!isNaN(progress) && isFinite(progress) && progress > 0) {
            storeProgress(currentCourseId, currentLessonId, progress);
            updateCompletionButton(currentCourseId, currentLessonId);
          }
        }
      }, 5000);
      
      // Enable restart button after some time has passed
      setTimeout(() => {
        document.getElementById('restartButton').classList.remove('opacity-50', 'cursor-not-allowed');
        document.getElementById('restartButton').disabled = false;
      }, 10000);
    }

    function onPlayerStateChange(event) {
      // If video ended
      if (event.data === YT.PlayerState.ENDED) {
        markLessonCompleted(currentCourseId, currentLessonId);
        updateCompletionButton(currentCourseId, currentLessonId);
        
        // Show completion message
        showToast('Lesson completed!', 'success');
      }
    }

    function getYouTubeVideoId(url) {
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    }

    function getYouTubeVideoDuration(videoId) {
      // This would typically make an API call to YouTube to get the duration
      // For our demo, we'll use a default duration
      return 600; // 10 minutes
    }

    function loadRegularVideo(url, progress) {
      const videoElement = document.getElementById('lessonVideo');
      videoElement.classList.remove('hidden');
      videoElement.src = url;
      
      // Set the current time based on stored progress
      videoElement.addEventListener('loadedmetadata', function() {
        if (progress > 0) {
          videoElement.currentTime = progress * videoElement.duration;
        }
        videoElement.play();
        
        // Enable restart button after some time has passed
        setTimeout(() => {
          document.getElementById('restartButton').classList.remove('opacity-50', 'cursor-not-allowed');
          document.getElementById('restartButton').disabled = false;
        }, 10000);
      });
      
      // Track progress
      videoElement.addEventListener('timeupdate', function() {
        const currentProgress = videoElement.currentTime / videoElement.duration;
        if (!isNaN(currentProgress) && isFinite(currentProgress)) {
          // Only update every 5 seconds to avoid excessive writes
          if (Math.round(videoElement.currentTime) % 5 === 0) {
            storeProgress(currentCourseId, currentLessonId, currentProgress);
            updateCompletionButton(currentCourseId, currentLessonId);
          }
        }
      });
      
      // Handle video completion
      videoElement.addEventListener('ended', function() {
        markLessonCompleted(currentCourseId, currentLessonId);
        updateCompletionButton(currentCourseId, currentLessonId);
        showToast('Lesson completed!', 'success');
      });
    }

    function updateCompletionButton(courseId, lessonId) {
      const completed = isLessonCompleted(courseId, lessonId);
      const progress = getStoredProgress(courseId, lessonId);
      const completeBtn = document.getElementById('markCompletedButton');
      
      if (progress === 1 || completed) {
        completeBtn.disabled = true;
        completeBtn.classList.add('opacity-50', 'cursor-not-allowed');
        completeBtn.classList.remove('hover:bg-purple-700');
        completeBtn.innerHTML = completed ? 
          '<i class="fas fa-check-double mr-2"></i>Lesson Completed' : 
          '<i class="fas fa-check mr-2"></i>Already at 100%';
      } else {
        completeBtn.disabled = false;
        completeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        completeBtn.classList.add('hover:bg-purple-700');
        completeBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Mark as Completed';
      }
    }

    function closeVideo() {
      // Clear the progress tracking interval
      if (youtubeProgressInterval) {
        clearInterval(youtubeProgressInterval);
        youtubeProgressInterval = null;
      }
      
      // Stop video playback
      const videoElement = document.getElementById('lessonVideo');
      videoElement.pause();
      videoElement.src = '';
      
      // Stop YouTube player if it exists
      if (youtubePlayer && youtubePlayer.stopVideo) {
        youtubePlayer.stopVideo();
      }
      
      // Hide the modal
      document.getElementById('videoModal').classList.add('hidden');
      
      // Disable restart button for next video
      document.getElementById('restartButton').disabled = true;
      document.getElementById('restartButton').classList.add('opacity-50', 'cursor-not-allowed');
      
      // Update UI
      renderCourses();
    }

    function restartLesson() {
      // Handle regular video
      const videoElement = document.getElementById('lessonVideo');
      if (!videoElement.classList.contains('hidden')) {
        videoElement.currentTime = 0;
        videoElement.play();
      }
      
      // Handle YouTube video
      if (youtubePlayer && youtubePlayer.seekTo) {
        youtubePlayer.seekTo(0);
        youtubePlayer.playVideo();
      }
    }

    function markCompleted() {
      markLessonCompleted(currentCourseId, currentLessonId);
      closeVideo();
      renderCourses();
    }

    // Add getDataStore function if it's missing

    // Initialize and get the data store
    function getDataStore() {
      if (!dataStore) {
        // Attempt to load from localStorage
        const storedData = localStorage.getItem('learningData');
        
        if (storedData) {
          try {
            dataStore = JSON.parse(storedData);
          } catch (e) {
            console.error("Error parsing stored data:", e);
            dataStore = createEmptyDataStore();
          }
        } else {
          // Initialize with empty structure if nothing exists
          dataStore = createEmptyDataStore();
        }
      }
      return dataStore;
    }
  </script>
</body>
</html>